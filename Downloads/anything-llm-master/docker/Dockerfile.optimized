# Optimized Dockerfile for faster builds
FROM ubuntu:jammy-20240627.1 AS base

# Build arguments
ARG ARG_UID=1000
ARG ARG_GID=1000

# Install system dependencies in one layer
RUN DEBIAN_FRONTEND=noninteractive apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -yq --no-install-recommends \
        curl gnupg libgfortran5 libgbm1 tzdata netcat \
        libasound2 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 \
        libgcc1 libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 libx11-6 libx11-xcb1 libxcb1 \
        libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 \
        libxss1 libxtst6 ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release \
        xdg-utils git build-essential ffmpeg unzip && \
    mkdir -p /etc/apt/keyrings && \
    curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg && \
    echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_18.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list && \
    apt-get update && \
    apt-get install -yq --no-install-recommends nodejs && \
    curl -LO https://github.com/yarnpkg/yarn/releases/download/v1.22.19/yarn_1.22.19_all.deb && \
    dpkg -i yarn_1.22.19_all.deb && \
    rm yarn_1.22.19_all.deb && \
    curl -LsSf https://astral.sh/uv/0.6.10/install.sh | sh && \
    mv /root/.local/bin/uv /usr/local/bin/uv && \
    mv /root/.local/bin/uvx /usr/local/bin/uvx && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Create user
RUN groupadd -g "$ARG_GID" anythingllm && \
    useradd -l -u "$ARG_UID" -m -d /app -s /bin/bash -g anythingllm anythingllm && \
    mkdir -p /app/frontend/ /app/server/ /app/collector/ && \
    chown -R anythingllm:anythingllm /app

# Copy package files first for better caching
COPY --chown=anythingllm:anythingllm package.json yarn.lock ./
COPY --chown=anythingllm:anythingllm server/package.json server/yarn.lock ./server/
COPY --chown=anythingllm:anythingllm frontend/package.json frontend/yarn.lock ./frontend/
COPY --chown=anythingllm:anythingllm collector/package.json collector/yarn.lock ./collector/

# Install dependencies
USER anythingllm
WORKDIR /app

# Install root dependencies
RUN mkdir -p /app/node_modules && \
    yarn install --frozen-lockfile --network-timeout 100000

# Install server dependencies
WORKDIR /app/server
RUN mkdir -p /app/server/node_modules && \
    yarn install --production --frozen-lockfile --network-timeout 100000

# Install frontend dependencies
WORKDIR /app/frontend
RUN mkdir -p /app/frontend/node_modules && \
    yarn install --frozen-lockfile --network-timeout 100000

# Install collector dependencies
WORKDIR /app/collector
RUN mkdir -p /app/collector/node_modules && \
    yarn install --production --frozen-lockfile --network-timeout 100000

# Ensure proper ownership
USER root
RUN chown -R anythingllm:anythingllm /app
USER anythingllm

# Copy application code
WORKDIR /app
COPY --chown=anythingllm:anythingllm server/ ./server/
COPY --chown=anythingllm:anythingllm collector/ ./collector/
COPY --chown=anythingllm:anythingllm frontend/ ./frontend/

# Build frontend
WORKDIR /app/frontend
RUN yarn build:ci

# Copy built frontend to server
WORKDIR /app
RUN cp -r /app/frontend/dist /app/server/public

# Copy docker scripts
COPY --chown=anythingllm:anythingllm docker/docker-entrypoint.sh /usr/local/bin/
COPY --chown=anythingllm:anythingllm docker/docker-healthcheck.sh /usr/local/bin/
COPY --chown=anythingllm:anythingllm docker/.env.example /app/server/.env

# Set permissions
RUN chmod +x /usr/local/bin/docker-entrypoint.sh && \
    chmod +x /usr/local/bin/docker-healthcheck.sh

# Final ownership fix
USER root
RUN chown -R anythingllm:anythingllm /app
USER anythingllm

# Expose port
EXPOSE 3001

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD /usr/local/bin/docker-healthcheck.sh

# Start application
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
CMD ["node", "server/index.js"]
